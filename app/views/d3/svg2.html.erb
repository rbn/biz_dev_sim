<style>
div#thediv {
  width:63.2%;
  margin:auto;
}
div#controls {
  width:8%;
  margin:auto;
}
svg {
  border:1px solid black;
  background-color:#c4cee9;
  padding:50px;
}

</style>

<script>
$(function() {

  // ----------------------------------
  // data -----------------------------

  var jsonCircles = [
  { "x": 30,  "y": 30,  "r": 40, "color" : "green" },
  { "x": 170, "y": 170, "r": 20, "color" : "purple" },
  { "x": 667, "y": 50, "r": 10, "color" : "purple" },
  { "x": 200, "y": 15, "r": 30, "color" : "purple" },
  { "x": 170, "y": 300, "r": 50, "color" : "purple" },
  { "x": 40, "y": 700, "r": 15, "color" : "purple" },
  { "x": 400, "y": 400, "r": 20, "color" : "red" }];

  // ----------------------------------
  // surface --------------------------

  var svg =  d3.select('#thediv')
                .append('svg')
                .attr('width', 800)
                .attr('height', 800);

  // ----------------------------------
  // logic ----------------------------

  draw_circles_path(svg, jsonCircles);
  draw_circles(svg, jsonCircles);

  // ---------------------------------
  // behaviour

  $('.myCircle').each(function() {
     new Circle(this);  
  });

});

// ------
// note - expects json to contain info about only one line
//
//  var lineData = [ { "x": 30,   "y": 30},  { "x": 70,  "y": 70},
//                   { "x": 70,  "y": 70}, { "x": 110,  "y": 110}];
function draw_circles_path(svg, json) {

  var transform_circles_to_path = function(json) {
    var arr = [];
    $.each(json, function(i, v) {
      var next = json[i + 1];

      if ( next !== undefined ) {
        arr.push({ "x": this.x, "y": this.y});
        arr.push({ "x": next.x, "y": next.y});
      }
    });
    return arr;
  };

  var lineFunction = d3.svg.line()
                            .x(function(d) { return d.x; })
                            .y(function(d) { return d.y; })
                            .interpolate("linear");

  var lineGraph = svg.append('path')
                     .attr('d', lineFunction(transform_circles_to_path(json)))
                     .attr('stroke', 'blue')
                     .attr('stroke-width', 4)
                     .style('fill', 'none');
}

// this should be a function off a circle object

function draw_circles(svg, json) {

  var defs = svg.append('svg:defs');

  var pattern = defs.selectAll('pattern')
                    .data([0])
                    .enter()
                    .append('pattern')
                    .attr('id', 'img-bkg')
                    .attr('x', 0)
                    .attr('y', 0)
                    .attr('patternUnits', 'userSpaceOnUse')
                    .attr('height', 1)
                    .attr('width', 1);

  var images = pattern.selectAll('image')
                  .data([0])
                  .enter()
                  .append('svg:image')
                  .attr('x', function (d) { return 0; }) // TODO: scale these
                  .attr('y', function (d) { return 0; })
                  .attr('height', 35)
                  .attr('width', 35)
                  .attr('xlink:href', 'http://www.pco.noaa.gov/stormwatch/images/iconsm-waves.gif');

                  
  var circles = svg.selectAll('circle')
                   .data(json)
                   .enter()
                   .append('circle');

  var circleAttributes = circles
                          .attr('cx', function (d) { return d.x; })
                          .attr('cy', function (d) { return d.y; })
                          .attr('r', function(d) { return d.r; })
                          .attr('class', 'myCircle')
                          .style('fill', function(d) { return d.color; })
                          ;

}

</script>

<div id="next_steps">
  next: find the right way to pass data to the circles from the db 
  to connect them to their models
</div>
<p>
<div id="controls" >
  <a href="#"><img src="http://iosapps.com/Dice-small-icon_799.jpg" /></a>
</div>
</p>
<p>
<div id="thediv">
</div>
</p>
